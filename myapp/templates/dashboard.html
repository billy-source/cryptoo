{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">

  <!-- Account Summary -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h5>ðŸ’µ Cash Balance</h5>
          <h4 class="text-success">${{ cash|floatformat:2 }}</h4>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h5>ðŸ“Š Portfolio Value</h5>
          <h4 class="text-primary">${{ portfolio_value|floatformat:2 }}</h4>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h5>ðŸ’¼ Total Equity</h5>
          <h4 class="text-dark">${{ total_equity|floatformat:2 }}</h4>
        </div>
      </div>
    </div>
  </div>

  <!-- Trade Form -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header">Execute Trade</div>
    <div class="card-body">
      <form method="post" class="row g-3">
        {% csrf_token %}
        <div class="col-md-4">
          {{ form.currency_pair.label_tag }}
          {{ form.currency_pair }}
        </div>
        <div class="col-md-2">
          {{ form.side.label_tag }}
          {{ form.side }}
        </div>
        <div class="col-md-3">
          {{ form.amount.label_tag }}
          {{ form.amount }}
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-success w-100">Submit Trade</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Holdings Table -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header">Your Holdings</div>
    <div class="card-body table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Quantity</th>
            <th>Avg. Cost</th>
            <th>Current Price</th>
            <th>Market Value</th>
          </tr>
        </thead>
        <tbody>
          {% for h in holdings %}
          <tr>
            <td>{{ h.currency_pair.base_currency }}/{{ h.currency_pair.quote_currency }}</td>
            <td>{{ h.quantity|floatformat:6 }}</td>
            <td>${{ h.average_cost|floatformat:2 }}</td>
            <td>${{ h.currency_pair.price|floatformat:2 }}</td>
            <td>${{ h.market_value|floatformat:2 }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="text-center">No holdings yet.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Recent Trades -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header">Recent Trades</div>
    <div class="card-body table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Side</th>
            <th>Symbol</th>
            <th>Amount</th>
            <th>Price</th>
            <th>Total</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          {% for t in trades %}
          <tr>
            <td><span class="badge {% if t.side == 'BUY' %}bg-success{% else %}bg-danger{% endif %}">{{ t.side }}</span></td>
            <td>{{ t.currency_pair.base_currency }}/{{ t.currency_pair.quote_currency }}</td>
            <td>{{ t.amount|floatformat:6 }}</td>
            <td>${{ t.price|floatformat:2 }}</td>
            <td>${{ t.total|floatformat:2 }}</td>
            <td>{{ t.timestamp|date:"Y-m-d H:i" }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="text-center">No trades yet.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Chart Section -->
  <div class="card shadow-sm">
    <div class="card-header">Price Chart</div>
    <div class="card-body">
      <canvas id="priceChart" height="100"></canvas>
    </div>
  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  async function loadChart(symbol="BTC") {
    const res = await fetch(`/api/price_history/${symbol}/`);
    const data = await res.json();

    const ctx = document.getElementById("priceChart").getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: data.timestamps,
        datasets: [{
          label: `${symbol} Price (USD)`,
          data: data.prices,
          borderColor: "rgba(75, 192, 192, 1)",
          fill: false,
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: "Time" } },
          y: { title: { display: true, text: "Price (USD)" } }
        }
      }
    });
  }

  loadChart("BTC"); // default BTC
</script>
{% endblock %}
